---
title: "Estimate network models"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
---

TO DISCUSS:
- lasso parameter? (don't do this)
- remove variables? (try after bootstrapping)
- simulation/bootstrapping? (do this first)
- moderation?

Condition-HADS:  Est    Quantiles of bootstrapped sampling dist    % bootstrapped samples it's nonzero in

(no CI because regularization removes/shrinks low estimates)

# Read in the data and libraries

```{r}

knitr::opts_chunk$set(error = TRUE)

library(tidyverse)
library(mgm)
library(qgraph)
library(psych)
library(corrr)
library(here)

``` 

```{r}

data_all_timepoints <- read_rds(file = here('4 Generated Datasets','Vars_At_All_Timepoints.rds'))

table(data_all_timepoints$Condition_Dummy)
```

# Generic model functions


## fit MGM functions
```{r}

fit_my_mgm <- function(my_data){
  
  set.seed(08132021)
  fit_mgm <- mgm::mgm(data = my_data, 
                      
                      # first variable (condition) has 2 conditions, all others are continuous
                      level = c(2,1,1,1,1,1,1), 
                      
                      # first variable (condition) is categorical, all others 
                      # have assumed Gaussian normal ('g') distributions
                      type = c("c","g","g","g","g","g","g"), 
                      
                      k =2,
                      
                      # ~~ test code to see if we can get signs for tx effect ~~
                      binarySign = TRUE,
                      
                      # per Jonas set this way
                      ruleReg = "OR")
  
  return(fit_mgm)
  
}

fit_my_mgm.moderated <- function(my_data){
  
  # could examine just specific moderation effects
  # as written, allows all edges to vary by condition
  
  set.seed(08132021)
  fit_mgm <- mgm::mgm(data = my_data, 
                      
                      # first variable (condition) has 2 conditions, all others are continuous
                      level = c(2,1,1,1,1,1,1), 
                      
                      # first variable (condition) is categorical, all others 
                      # have assumed Gaussian normal ('g') distributions
                      type = c("c","g","g","g","g","g","g"), 
                      
                      moderator = 1, #check syntax
                      
                      # per Jonas set this way
                      ruleReg = "OR")
  
  return(fit_mgm)
  
}

```

# Single timepoint models - Generic functions

## extract data for one timepoint

```{r}

getDataForTimepoint <- function(data_all_timepoints, my_timepoint){
  data_to_return <- data_all_timepoints %>% filter(timepoint == my_timepoint) %>%
    select(-timepoint, -ID, -CESD) %>%
    
  # drop full rows with any missing observations
    drop_na()
  }

```




bootstrap with resample() - 1000 replicants is sufficient, maybe 10K
can loop thru models and look to see number of samples showing indirect effects of interest


## Wrapper to call everything

```{r}

runNetworkForOneTimepoint <- function(data_all_timepoints, timepoint, moderated = FALSE){
  
  data <- getDataForTimepoint(data_all_timepoints, timepoint)

  #psych::describe(data)
  
  #get_correlations(data)
  
  ifelse(moderated == TRUE,
         network.fit <- fit_my_mgm.moderated(data),
         network.fit <- fit_my_mgm(data))
  
  return(network.fit)
  #plot_my_mgm(network.fit)

}
```

## Estimate networks at one timepoint

### Pre

This model has to be specified differently than the rest because we don't want condition modeled

```{r}

Pre.data <- getDataForTimepoint(data_all_timepoints, 1) %>%
  select(-Condition_Dummy)

#psych::describe(Pre.data)
  
set.seed(08132021)

Pre.fit <- mgm::mgm(data = Pre.data, 
         
         # tells model that all variables are continuous
         level = c(1,1,1,1,1,1,1), 
         
         # tells model that all variables have assumed Gaussian normal distribution
         type = c("g","g","g","g","g","g","g"), 
         
         k =2,
         
         # per Jonas set this way
         ruleReg = "OR")

     

```


### Mid, Post, 3mFU, 6mFU
```{r}

Mid.fit <- runNetworkForOneTimepoint(data_all_timepoints, 2)

Post.fit <- runNetworkForOneTimepoint(data_all_timepoints, 3)

my3mFU.fit <- runNetworkForOneTimepoint(data_all_timepoints, 4)

my6mFU.fit <- runNetworkForOneTimepoint(data_all_timepoints, 5)

```

### Save model fits

```{r}

write_rds(x = Pre.fit , file = here('Fitted model objects','Pre.fit'))

write_rds(x = Mid.fit , file = here('Fitted model objects','Mid.fit'))

write_rds(x = Post.fit , file = here('Fitted model objects','Post.fit'))

write_rds(x = my3mFU.fit , file = here('Fitted model objects','my3mFU.fit'))

write_rds(x = my6mFU.fit , file = here('Fitted model objects','my6mFU.fit'))

```

# Change score models - setup and generic functions

## Create dataset of change scores

```{r}

ChangeScores_data <- data_all_timepoints %>%
  
  pivot_longer(cols = HADS.A:AAQc, names_to = 'instrument') %>%
  pivot_wider(id_cols = c('ID','instrument','timepoint', 'Condition_Dummy'),
              names_from = 'timepoint',
              values_from = 'value') %>%
  mutate(PreToMid = (`2` - `1`),
         MidToPost = (`3` - `2`),
         PostTo3mFU = (`4` - `3`),
         `3mFUTo6mFU` = (`5` - `4`),
         PreToPost = (`3` - `1`),
         PreTo6mFU = (`5` - `1`)) %>%
  # drop scores at each timepoint since change scores have now been computed
  dplyr::select(-`1`, -`2`, -`3`, -`4`, -`5`) %>%
  
  # tidy
  pivot_longer(cols = PreToMid:PreTo6mFU, names_to = 'ChangeScore') %>%
  
  # pivot to long by interval, by participant, wide by instrument
  # consistent with format we will want to estimate networks
  pivot_wider(names_from = instrument)

```

## Extract data for one interval

```{r}

getDataForInterval <- function(ChangeScores, my_interval){
  data_to_return <- ChangeScores %>% filter(ChangeScore == my_interval) %>%
    select(-ChangeScore, -ID) %>%
    
  # drop full rows with any missing observations
    drop_na()
  return(data_to_return)
}

```

## Wrappers

```{r}

runChangeScoreNetwork <- function(ChangeScore_data, my_interval, moderated = FALSE){
  
  data <- getDataForInterval(ChangeScore_data, my_interval) %>%
    as.matrix()
  
  ifelse(moderated == TRUE,
         fit <- fit_my_mgm.moderated(data),
         fit <- fit_my_mgm(data))
  
  return(fit)

}

runBootstrappedChangeScoreNetwork <- function(ChangeScore_data, my_interval, nB = 5000){
  
  data <- getDataForInterval(ChangeScore_data, my_interval) %>%
    as.matrix()
  
  fit <- fit_my_mgm(data)
  
  fit.boot <- resample(object = fit, 
                               data = data, 
                               nB = nB)
  
  return(fit.boot)

}
```
# Unmoderated Change Score Network Models

## PreToMid


```{r}

PreToMid.fit <- runChangeScoreNetwork(ChangeScores_data, 'PreToMid')

write_rds(x = PreToMid.fit, file = here('Fitted model objects',
                                         'Nonmoderated',
                                        'Nonbootstrapped',
                                        'PreToMid.fit'))

PreToMid.fit.boot <- runBootstrappedChangeScoreNetwork(ChangeScores_data, 'PreToMid')

write_rds(x = PreToMid.fit.boot, file = here('Fitted model objects','PreToMid.fit.boot'))


```

## MidToPost

```{r}

MidToPost.fit <- runChangeScoreNetwork(ChangeScores_data, 'MidToPost')

write_rds(x = MidToPost.fit, file = here('Fitted model objects',
                                         'Nonmoderated',
                                        'Nonbootstrapped',
                                        'MidToPost.fit'))


MidToPost.fit.boot <- runBootstrappedChangeScoreNetwork(ChangeScores_data, 'MidToPost')

write_rds(x = MidToPost.fit, file = here('Fitted model objects','MidToPost.fit.boot'))


```

## PostTo3mFU

```{r}

PostTo3MFU.fit <- runChangeScoreNetwork(ChangeScores_data, 'PostTo3mFU')

write_rds(x = PostTo3MFU.fit, file = here('Fitted model objects',
                                         'Nonmoderated',
                                        'Nonbootstrapped',
                                        'PostTo3MFU.fit'))


PostTo3MFU.fit.boot <- runBootstrappedChangeScoreNetwork(ChangeScores_data, 'PostTo3mFU')

write_rds(x = PostTo3MFU.fit, file = here('Fitted model objects','PostTo3MFU.fit.boot'))


```


## 3mFUTo6mFU

```{r}
my3mTo6mFU.fit <- runChangeScoreNetwork(ChangeScores_data, '3mFUTo6mFU')

write_rds(x = my3mTo6mFU.fit, file = here('Fitted model objects',
                                         'Nonmoderated',
                                        'Nonbootstrapped',
                                        'my3mTo6mFU.fit'))


my3mTo6mFU.fit.boot <- runBootstrappedChangeScoreNetwork(ChangeScores_data, '3mFUTo6mFU')

write_rds(x = my3mTo6mFU.fit , file = here('Fitted model objects','my3mTo6mFU.fit.boot'))


```


## PreToPost 

```{r}

PreToPost.fit <- runChangeScoreNetwork(ChangeScores_data, 'PreToPost')

write_rds(x = PreToPost.fit, file = here('Fitted model objects',
                                         'Nonmoderated',
                                        'Nonbootstrapped',
                                        'PreToPost.fit'))

PreToPost.fit.boot <- runBootstrappedChangeScoreNetwork(ChangeScores_data, 'PreToPost')

write_rds(x = PreToPost.fit.boot, file = here('Fitted model objects','PreToMid.fit.boot'))

PreToPost.fit.boot <- read_rds(file = here('Fitted model objects','PreToMid.fit.boot'))
mgm::plotRes(PreToPost.fit.boot, labels = c('TX','HADS','IESR','FCR','SCS','EAC','AAQc'))

PreToPost.fit$interactions
```
\newpage

## PreTo6mFU 
```{r}
# PreTo6mFU.fit <- runBootstrappedChangeScoreNetwork(ChangeScores_data, 'PreTo6mFU')
# 
# write_rds(x = PreTo6mFU.fit , file = here('Fitted model objects','PreTo6mFU.fit.boot'))


```






# Moderated Change Score Network Models


## PreToMid

```{r}
PreToMid.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, 'PreToMid', moderated = TRUE)

write_rds(x = PreToMid.moderated.fit, file = here('Fitted model objects',
                                                  'Moderated',
                                                  'Not bootstrapped',
                                                  'PreToMid.moderated.fit'))

```

## MidToPost

```{r}
MidToPost.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, 'MidToPost', moderated = TRUE)

write_rds(x = MidToPost.moderated.fit, file = here('Fitted model objects',
                                                   'Moderated',
                                                   'Not bootstrapped',
                                                   'MidToPost.moderated.fit'))


```

## PostTo3mFU

```{r}
PostTo3MFU.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, 'PostTo3mFU', moderated = TRUE)

write_rds(x = PostTo3MFU.moderated.fit, file = here('Fitted model objects',
                                                    'Moderated',
                                                    'Not bootstrapped',
                                                    'PostTo3MFU.moderated.fit'))


```


## 3mFUTo6mFU

```{r}
my3mTo6mFU.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, '3mFUTo6mFU', moderated = TRUE)

write_rds(x = my3mTo6mFU.moderated.fit , file = here('Fitted model objects',
                                                     'Moderated',
                                                     'Not bootstrapped',
                                                     'my3mTo6mFU.moderated.fit'))


```


## PreToPost 

```{r}

PreToPost.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, 'PreToPost', moderated = TRUE)

write_rds(x = PreToPost.moderated.fit , file = here('Fitted model objects',
                                                    'Moderated',
                                                    'Not bootstrapped',
                                                    'PreToPost.moderated.fit'))

```
\newpage

## PreTo6mFU 
```{r}
PreTo6mFU.moderated.fit <- runChangeScoreNetwork(ChangeScores_data, 'PreTo6mFU', moderated = TRUE)

write_rds(x = PreTo6mFU.moderated.fit , file = here('Fitted model objects',
                                                    'Moderated',
                                                    'Not bootstrapped',
                                                    'PreTo6mFU.moderated.fit'))


```





