---
title: "Estimate and plot networks"
output:
  html_document:
    df_print: paged
---
Per Jonas's suggestion I will attempt to model no more than 8 variables simultaneously.

The seven variables Joanna and I chose in descending order of importance to keep in the model are:

HADS-A
IES-R
FCR
Self Compassion
EAC
AAQc
CESD

# Read in the data and libraries

```{r}
library(tidyverse)
library(mgm)
library(qgraph)
library(psych)
library(corrr)
library(here)

``` 

```{r}
data <- read_rds(file = here('4 Generated Datasets','Vars_At_Pre_Data.rds'))

data_all_timepoints <- read_rds(file = here('4 Generated Datasets','Vars_At_All_Timepoints.rds'))
```

# Single timepoint models - Generic functions

## extract data for one timepoint

```{r}

getDataForTimepoint <- function(data_all_timepoints, my_timepoint){
  data_to_return <- data_all_timepoints %>% filter(timepoint == my_timepoint) %>%
    select(-timepoint, -ID) %>%
    
  # drop full rows with any missing observations
    drop_na()
  }

```


## Examine bivariates

corrr package used for easy computation and display of the correlation matrix

```{r}

get_correlations <- function(my_data){
  my_data %>%
  select(-Condition_Dummy) %>%
  corrr::correlate() %>%
  corrr::rearrange() %>%
  corrr::shave() %>%
  corrr::fashion()
}

```

## fit MGM
```{r}

fit_my_mgm <- function(my_data){
  
  set.seed(08132021)
  fit_mgm <- mgm::mgm(data = my_data, 
                      
                      # first variable (condition) has 2 conditions, all others are continuous
                      level = c(2,1,1,1,1,1,1,1), 
                      
                      # first variable (condition) is categorical, all others 
                      # have assumed Gaussian normal ('g') distributions
                      type = c("c","g","g","g","g","g","g","g"), 
                      
                      k =2,
                      
                      # per Jonas set this way
                      ruleReg = "OR")
  
  return(fit_mgm)
  
}

```

## plot MGM
```{r}

plot_my_mgm <- function(my_mgm_fit){
  
  my_edgeweights <- my_mgm_fit$pairwise$wadj
  
  my_colorblind_edge_colors <- my_mgm_fit$pairwise$edgecolor_cb
  
  qgraph(my_edgeweights, 
         layout = 'spring', repulsion = 1.3,
         edge.color = my_colorblind_edge_colors, 
         legend.cex=.4, 
         vsize = 3.5, esize = 15, labels = c('ACT or MEUC','HADS','IESR','FCR','SCS','EAC','AAQc','CESD'))
}
  
```

## Wrapper to call everything

```{r}

runNetworkForOneTimepoint <- function(data_all_timepoints, timepoint){
  
  data <- getDataForTimepoint(data_all_timepoints, timepoint)

  psych::describe(data)
  
  get_correlations(data)
  
  network.fit <- fit_my_mgm(data)
  
  plot_my_mgm(network.fit)

}
```

# Estimate networks at one timepoint

## Pre

This model has to be specified differently than the rest because we don't want condition modeled

```{r}

pre.data <- getDataForTimepoint(data_all_timepoints, 1) %>%
  select(-Condition_Dummy)

psych::describe(pre.data)
  
set.seed(08132021)

pre.fit <- mgm::mgm(data = pre.data, 
         
         # tells model that all variables are continuous
         level = c(1,1,1,1,1,1,1), 
         
         # tells model that all variables have assumed Gaussian normal distribution
         type = c("g","g","g","g","g","g","g"), 
         
         k =2,
         
         # per Jonas set this way
         ruleReg = "OR")

# plot
my_edgeweights <- pre.fit$pairwise$wadj
  
  my_colorblind_edge_colors <- pre.fit$pairwise$edgecolor_cb
  
  qgraph(my_edgeweights, 
         layout = 'spring', repulsion = 1.3,
         edge.color = my_colorblind_edge_colors, 
         legend.cex=.4, 
         vsize = 3.5, esize = 15, labels = c('HADS','IESR','FCR','SCS','EAC','AAQc','CESD'))
         

```


## Mid
```{r}

runNetworkForOneTimepoint(data_all_timepoints, 2)

```

## Post

```{r}
runNetworkForOneTimepoint(data_all_timepoints, 3)


```

## 3m FU

```{r}
runNetworkForOneTimepoint(data_all_timepoints, 4)

```

## 6m FU
```{r}
runNetworkForOneTimepoint(data_all_timepoints, 5)
```


# Change score models - setup and generic functions

## Create dataset of change scores

```{r}

ChangeScores_data <- data_all_timepoints %>%
  
  pivot_longer(cols = HADS.A:CESD, names_to = 'instrument') %>%
  pivot_wider(id_cols = c('ID','instrument','timepoint', 'Condition_Dummy'),
              names_from = 'timepoint',
              values_from = 'value') %>%
  mutate(PreToMid = (`2` - `1`),
         MidToPost = (`3` - `2`),
         PostTo3mFU = (`4` - `3`),
         `3mFUTo6mFU` = (`5` - `4`),
         PreToPost = (`3` - `1`),
         PreTo6mFU = (`5` - `1`)) %>%
  # drop scores at each timepoint since change scores have now been computed
  dplyr::select(-`1`, -`2`, -`3`, -`4`, -`5`) %>%
  
  # tidy
  pivot_longer(cols = PreToMid:PreTo6mFU, names_to = 'ChangeScore') %>%
  
  # pivot to long by interval, by participant, wide by instrument
  # consistent with format we will want to estimate networks
  pivot_wider(names_from = instrument)

```

## Extract data for one interval

```{r}

getDataForInterval <- function(ChangeScores, my_interval){
  data_to_return <- ChangeScores %>% filter(ChangeScore == my_interval) %>%
    select(-ChangeScore, -ID) %>%
    
  # drop full rows with any missing observations
    drop_na()
}

```

```{r}

runChangeScoreNetwork <- function(ChangeScore_data, my_interval){
  
  data <- getDataForInterval(ChangeScore_data, my_interval)

  psych::describe(data)
  
  get_correlations(data)
  
  network.fit <- fit_my_mgm(data)
  
  plot_my_mgm(network.fit)

}
```
# Change Score Network Models

## PreToMid

```{r}
runChangeScoreNetwork(ChangeScores_data, 'PreToMid')
```


## MidToPost

```{r}
runChangeScoreNetwork(ChangeScores_data, 'MidToPost')
```

## PostTo3mFU

```{r}
runChangeScoreNetwork(ChangeScores_data, 'PostTo3mFU')
```


## 3mFUTo6mFU

```{r}
runChangeScoreNetwork(ChangeScores_data, '3mFUTo6mFU')
```


## PreToPost 
```{r}
runChangeScoreNetwork(ChangeScores_data, 'PreToPost')
```

## PreTo6mFU 
```{r}
runChangeScoreNetwork(ChangeScores_data, 'PreTo6mFU')
```
