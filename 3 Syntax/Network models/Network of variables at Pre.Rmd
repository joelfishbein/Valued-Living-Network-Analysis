---
title: "Estimate and plot networks"
output: html_notebook
---
Per Jonas's suggestion I will attempt to model no more than 8 variables simultaneously.

The seven variables Joanna and I chose in descending order of importance to keep in the model are:

HADS-A (drop first among anx measures?)
IES-R
FCR
Self Compassion
EAC
AAQc
CESD

# Read in the data and libraries

```{r}
library(tidyverse)
library(mgm)
library(qgraph)
library(psych)
library(skimr)  
library(corrr)

``` 

```{r}
data <- read_rds(file = here('4 Generated Datasets','Vars_At_Pre_Data.rds'))
presence <- read_rds(file = here('4 Generated Datasets','Vars_At_Pre_Presence.rds'))


data_all_timepoints <- read_rds(file = here('4 Generated Datasets','Vars_At_All_Timepoints.rds'))
```

# Examine univariates

Distributions look ok.

```{r}
data %>%  
  select(-ID, -Condition_Dummy, -Condition) %>%
  psych::describe()
  

```

# Examine bivariates

corrr package used for easy computation and display of the correlation matrix

```{r}

get_correlations <- function(my_data){
  my_data %>%
  corrr::correlate() %>%
  corrr::rearrange() %>%
  corrr::shave() %>%
  corrr::fashion()
}

```

No correlations looking too high here which is good...
```{r}

get_correlations(data)
  
```

# Estimate network model for Pre, excluding condition

Exclude condition because no treatment has taken place...so any treatment effects would be spurious

## Setup data object

Data must not contain any missing values (i.e. NAs)


```{r}

responses <- data %>% select(-ID, -Condition_Dummy, -Condition) %>%
  drop_na()

responses %>%
  psych::describe()

colnames(responses)

```

### Estimate Pre model


```{r}

set.seed(08132021)
fit_mgm <- mgm::mgm(data = responses, 
         
         # tells model that all variables are continuous
         level = c(1,1,1,1,1,1,1), 
         
         # tells model that all variables have assumed Gaussian normal distribution
         type = c("g","g","g","g","g","g","g"), 
         
         k =2,
         
         # per Jonas set this way
         ruleReg = "OR")
         

```

## Plot Pre model estimates
```{r}

width <- 9
pdf(here('5 Tables and Figures', 'Pre Network.pdf'), width = width, height = width*.6)

qgraph(fit_mgm$pairwise$wadj, 
       layout = 'spring', repulsion = 1.3,
       edge.color = fit_mgm$pairwise$edgecolor_cb, 
        legend.cex=.4, 
       vsize = 3.5, esize = 15, labels = c('HADS','IESR','FCR','SCS','EAC','AAQc','CESD'))

```

# Generic functions for Mid, Post, 3mFU, 6mFU
```{r}

fit_my_mgm <- function(my_data){
  
  set.seed(08132021)
  fit_mgm <- mgm::mgm(data = my_data, 
                      
                      # first variable (condition) has 2 conditions, all others are continuous
                      level = c(2,1,1,1,1,1,1,1), 
                      
                      # first variable (condition) is categorical, all others 
                      # have assumed Gaussian normal ('g') distributions
                      type = c("c","g","g","g","g","g","g","g"), 
                      
                      k =2,
                      
                      # per Jonas set this way
                      ruleReg = "OR")
  
  return(fit_mgm)
  
}

```

```{r}

plot_my_mgm <- function(my_mgm_fit){
  
  my_edgeweights <- my_mgm_fit$pairwise$wadj
  
  my_colorblind_edge_colors <- my_mgm_fit$pairwise$edgecolor_cb
  
  qgraph(my_edgeweights, 
         layout = 'spring', repulsion = 1.3,
         edge.color = my_colorblind_edge_colors, 
         legend.cex=.4, 
         vsize = 3.5, esize = 15, labels = c('ACT or MEUC','HADS','IESR','FCR','SCS','EAC','AAQc','CESD'))
}
  


```

# Mid model

```{r}

data.mid <- data_all_timepoints %>% filter(timepoint == 2) %>%
  select(-timepoint, -ID) %>%
  drop_na()

```

## Descriptives

### Univariates

```{r}
psych::describe(data.mid)

```

### Bivariates

```{r}
get_correlations(data.mid)

```


```{r}
mid.fit <- fit_my_mgm(data.mid)

plot_my_mgm(mid.fit)
```

# Post model

```{r}

data.post <- data_all_timepoints %>% filter(timepoint == 3) %>%
  select(-timepoint, -ID) %>%
  drop_na()

```

## Descriptives

### Univariates

```{r}
psych::describe(data.post)

```

### Bivariates

```{r}
get_correlations(data.post)

```


```{r}
post.fit <- fit_my_mgm(data.post)

plot_my_mgm(post.fit)
```