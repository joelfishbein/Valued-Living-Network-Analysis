---
title: "Demographics for Dissertation Project"
output: html_notebook
date: June 7 2021
---

# INFORMATION ON SCRIPT

*Purpose*: This script produces a Table 1 to be used generally for the Valued Living Study in my dissertation project.
Currently it produces a table for Chapter 1 describing baseline demographics and contrast scores on all variables analyzed in the dissertation.

*Background*: The script is adapted from the script used to generate the demographics table for the Valued Living Causal Steps mediation paper.

*Input*: Raw data from Qualtrics

*Output*: An image of Table 1


# Setup

```{r}
library(tidyverse)
library(kableExtra)
library(tableone)
library(here)

# most of the demographic variables are stored here
outcomesDB <- read_csv('~/Data - lives on HD/RCT ACT for CA Survivors/Outcome database/current/data/RCT_Qualtrics_Unabridged_10.12.20.csv',
                   na = '#NULL!')

# a couple extra variables are stored here 
baselineDB <- read_csv('~/Data - lives on HD/RCT ACT for CA Survivors/Baseline data/BL MINI Database 6.13.19_FINAL.csv',
                   na = '#NULL!')

csrDB <- read_csv('~/Data - lives on HD/RCT ACT for CA Survivors/MINI symptom severity/Most severe disorder database_12.18.19.csv',
                   na = '#NULL!')


```
## Per Annette Stanton comment, turn EAC scores into means not sums

```{r}

outcomesDB <- outcomesDB %>%
  mutate(EAC_Mean_T1 = (EAC_Tot_T1/8),
         EAC_Mean_T2 = (EAC_Tot_T2/8),
         EAC_Mean_T3 = (EAC_Tot_T3/8),
         EAC_Mean_T4 = (EAC_Tot_T4/8),
         EAC_Mean_T5 = (EAC_Tot_T5/8))


```




```{r}
outcomesDB_for_TableOne <-
outcomesDB %>%
  mutate(ConditionFactor = factor(Condition,
                                  levels = c(-1,1),
                                  labels = c('Usual Care','ACT')),
         Age = Q_Age_T1,
         Female = factor(Q_Gender_T1, 
                         levels = c(1,2,3), 
                         labels = c('Male', 'Female', 'Other - please specify')),
         RaceEthnicity = factor(Q_Ethnic_T1,
                                levels = c(1:6),
                                labels = c('Black','White','Hispanic/Latino','Native American',
                                           'Asian American','Biracial please specify')),
         MonthsPostTx = Months_Post_TX_T1,
         HadChemo = factor(Canc_Hist_Q5_T1, 
                               exclude = '', 
                               levels = c(NA, 1), 
                               labels = c('No','Yes')),
         HadRadiation = factor(Canc_Hist_Q6_T1, 
                               exclude = '', 
                               levels = c(NA, 1), 
                               labels = c('No','Yes')),
         HadSurgery = factor(Canc_Hist_Q7_T1, 
                               exclude = '', 
                               levels = c(NA, 1), 
                               labels = c('No','Yes')),
         HadHormoneTx = factor(Canc_Hist_Q8_T1, 
                               exclude = '', 
                               levels = c(NA, 1), 
                               labels = c('No','Yes')),
         CancerStage = factor(Canc_Stage_ST,
                              exclude = '',
                              levels = c(1:6),
                              labels = c('Stage 0','Stage 1',
                                         'Stage 2','Stage 3',
                                         'Stage 4','Unknown')),
         HAD_A_T1,
         IESR.Total_T1 = Trauma_Mean_T1,
         CARS_T1 = Mean_fearofrec_T1,
         Total_FACITsp_T1,
         CESD_T1,
         BEAQ_T1 = Total_BEAQ_T1,
         AAQc_T1,
         Bulleye_Tot_T1,
         ValuedLivingQ_T1,
         SelfComp_Mean_T1,
         EAC_Mean_T1,
         isFemale = if_else(Female == 'Female', TRUE,FALSE),
         isWhite = if_else(RaceEthnicity == 'White', TRUE,FALSE),
         isStage0toII = if_else(CancerStage %in% c('Stage 0','Stage 1','Stage 2'), TRUE,FALSE))

         



```

# copy variables over from baseline DB

Per Sarah email 1/19/21, here are the variables to grab from baselineDB

Cancer type: Canc_Type_T1 
If they are taking at least one type of ET: T1_HT_Meds
If they are taking at least one type of chemo: T1_Chemo_Med

```{r}

extra_cancer_details <- baselineDB %>%
  select(Part_ID,
         
         cancer_type_descriptive = Canc_Hist,
         CancerType = Canc_Type_T1,
         Current_Hormone_Therapy = T1_HT_Med,
         Current_Chemo= T1_Chemo_Med) %>%
  
  
  mutate(
    CancerType = factor(CancerType,
                        levels = c(1:8),
                        labels = c('Breast', "Gastrointestinal", 'Gynecologic','Blood', 'Lung', 'Prostate or testicular', 'Nasopharyngeal', 'Other')),
    hasBreastCancer = if_else(CancerType == 'Breast', TRUE,FALSE),
    Current_Hormone_Therapy_YesNo = factor(Current_Hormone_Therapy,
                                                levels = c(0,1),
                                                labels = c('No','Yes')),
         Current_Chemo_YesNo = factor(Current_Chemo,
                                                levels = c(0,1),
                                                labels = c('No','Yes')))


```


## Add extra cancer details into Outcomes DB for Table One
```{r}

outcomesDB_for_TableOne <- left_join(outcomesDB_for_TableOne, 
                                     extra_cancer_details,
                                     by = c('ID' = 'Part_ID'))



```

# Add CSR data in

## Get right variable

```{r}

myCSRdata <- 
  csrDB %>%
  select(Part_ID, CSR = Most_severe_AD_or_MDE)

```


## Add it into the overall db

```{r}

outcomesDB_for_TableOne <- left_join(outcomesDB_for_TableOne, 
                                     myCSRdata,
                                     by = c('ID' = 'Part_ID'))

```


# Create Table One


## Create TableOne object

```{r}

table1 <- CreateTableOne(data = outcomesDB_for_TableOne,
               strata = 'ConditionFactor',
               vars = c('Age', 
                        'Female',
                        'isFemale', 
                        'RaceEthnicity',
                          'isWhite',
                        'MonthsPostTx',
                        'HadSurgery',
                        'HadChemo',
                        'HadRadiation',
                        'Current_Hormone_Therapy_YesNo',
                        'Current_Chemo_YesNo',
                        'CancerType',
                         'hasBreastCancer',
                        'CancerStage',
                        'isStage0toII',
                        'IESR.Total_T1',
                        'CARS_T1',
                        'HAD_A_T1', 
                        'BEAQ_T1',
                        'AAQc_T1',
                        'Bulleye_Tot_T1',
                        'Total_FACITsp_T1',
                        'CSR',
                        'CESD_T1',
                        'ValuedLivingQ_T1',
                        'SelfComp_Mean_T1',
                        'EAC_Mean_T1'
                              
                       
                        ),
               
               # show missing data
               includeNA = TRUE, 
              
              # add Overall column
              addOverall = TRUE)
               


```

## Create output to copy into Excel

Outputting as Kable or csv is not working.

So output the text, copy to a text editor (eg iA writer),
save as a text file, then open that text file as space-delimited
in Excel.

Then hand-edit the Excel file as needed.

```{r}

table_to_print <- print(table1,
                                    catDigits = 2,
                                    nospaces = TRUE,
                                    explain = TRUE,
                                    format = 'pf',
                                    quote = TRUE,
               # denote which variables should be compared with Fisher's
               # exact test due to small cell size
                                    exact = c('isFemale', 
                                                'isWhite',
                                              'isStage0toII',
                                              'hasBreastCancer',
                                              'Current_Chemo_YesNo',
                                              'Current_Hormone_Therapy_YesNo'))



table_to_print

```



